import collections
import numpy

# calibrate these with 'calibrate_scene_transforms_node.py'
#GRAV_TO_WORLD_MARKER_QUATERNION = [-0.0013205714067287897, -0.019854095959762185, -5.397549722797079e-05, 0.99980201442656935]
GRAV_TO_WORLD_MARKER_QUATERNION = [0.0, 0.0, 0.0, 1.0]
DEFAULT_Z_P = 1.0 

PLATFORM_TO_WORLD_MATRIX = numpy.array(
#[[0.99859661413500722, 0.012740827556684485, 0.051404995392182511, 1.1153716861566849], [-0.013454766737007623, 0.99981744379377946, 0.013566441601443326, 0.094973738857269965], [-0.051222763398241104, -0.014239044871180379, 0.99858573898839775, 0.63520125484167911], [0.0, 0.0, 0.0, 1.0]]
#[[0.99739750910641267, 0.034448111446793106, 0.063336691151912303, 0.96701221508941904], [-0.034852727410833631, 0.99937843569100815, 0.0052943052253926265, 0.15067631233304549], [-0.063114944508804963, -0.0074879832760774293, 0.99797817305094794, 0.62053184495395219], [0.0, 0.0, 0.0, 1.0]]
#[[0.99930709347222302, 0.033180432953699164, 0.016863920217519507, 0.91385427491043303], [-0.033353184864760001, 0.99939291677426589, 0.010067917401453222, 0.16245543921787109], [-0.016519624556113034, -0.010623406724324129, 0.99980710401261641, 0.66337090914073971], [0.0, 0.0, 0.0, 1.0]]
#[[0.99699844944160165, -0.066582959578356971, 0.039506977925791678, 0.8374641924126327], [0.066337772169356046, 0.99776913830518765, 0.0074864296784155834, 0.18406727100523104], [-0.039917311966723393, -0.0048431538804929782, 0.99919124899382561, 0.64099215225051021], [0.0, 0.0, 0.0, 1.0]]
#[[0.99913686933167767, -0.030203393012988123, 0.028517913538636513, 0.7945435328416659], [0.030130955580658796, 0.999541557666213, 0.0029664817540411888, 0.23230516086688358], [-0.028594437534082289, -0.0021046493065765316, 0.99958887978678812, 0.66078834403331621], [0.0, 0.0, 0.0, 1.0]]
#[[0.99891627058018362, -0.038563552508567717, 0.026060253032088157, 0.78790853777942305], [0.038502400120026536, 0.99925445914370326, 0.0028444799915961598, 0.24118570497650893], [-0.026150517302242791, -0.0018380150554745947, 0.99965632701718099, 0.65948482736307623], [0.0, 0.0, 0.0, 1.0]]
#[[0.99958195885316103, -0.0017471630949021744, 0.028859226538445259, 0.80082685595487191], [0.0014456544745873009, 0.99994419404632873, 0.010465126668044895, 0.17893296590452612], [-0.028875900304883951, -0.010419031344512338, 0.99952870202282063, 0.65574397276185137], [0.0, 0.0, 0.0, 1.0]]
#[[0.99893350351182353, -0.025057170234133654, 0.038781358684957565, 0.78599107774690857], [0.02488113998003811, 0.99967783679716282, 0.0050151261039973272, 0.15755849485476089], [-0.038894529626766747, -0.0040448530755631566, 0.99923513485500981, 0.65902946820543407], [0.0, 0.0, 0.0, 1.0]]
[[0.99950697795085608, 0.0073654455779733922, 0.030521324332095232, 0.78833889973491877], [-0.0073416435686474183, 0.99997265207061736, -0.00089184111084297606, 0.29136459823791788], [-0.030527058444238846, 0.00066732472902166851, 0.99953371798076329, 0.67317565476895325], [0.0, 0.0, 0.0, 1.0]]
)

DROP_SHIFT_AMOUNT = 0.1

# end calibrated

IMU_TOPIC = "/mini_ahrs_ros/imu"
RC_OVERRIDE_TOPIC = "/mavros/rc/override"
DEPTH_TOPIC = "/mavros/imu/static_pressure"
GOAL_POSE_TOPIC = "/goal_pose"
AR_MARKER_TOPIC = "/bluerov_controller/ar_tag_detector"
BUILD_PHASE_TOPIC = "/droplet_underwater_assembly/build_phase"

INPUT_LED_TOPIC = "/flash_detected"

MIN_SERVO_PWM = 0 
MAX_SERVO_PWM = 2400

# the angle it starts at
WRIST_ROTATION_INITIAL = 1440
FINGER_POSITION_INITIAL = 1400
FINGER_OPEN_POSITION = 2100
FINGER_CLOSED_POSITION = 1500

DEFAULT_POSITION_HOLD_TIME = 6.0

#WRIST_SERVO_INDEX = 1
FINGER_SERVO_INDEX = 2

MAV_CMD_DO_SET_SERVO = 183

MARKER_LOSS_TIME = 10.0

SERVO_TICK_DELAY = 0.05

RANDOMLY_DISPLACE_CENTER_BACK = True
RANDOM_DISPLACEMENT_RANGE = [0.2, 0.2, 0.1, 0.2]

BuildStep = collections.namedtuple('BuildStep', ['pickup_slot', 'drop_slot', 'pickup_wrist_pwm', 'drop_wrist_pwm'])

PICKUP_PLATFORM_DIMENSIONS = [4, 12]
DROP_PLATFORM_DIMENSIONS = [4, 15]

MIN_PICKUP_SLOT = [-1.94, 0.12, -0.32, 0, 0, 0]
MIN_DROP_SLOT = [-1.94, -0.115, -0.35, 0, 0, 0]

TRACKED_MARKER_ID = 0
TIGHT_POSE_TOLERANCE = [0.02, 0.02, 0.025, float("inf"), float("inf"), 0.02]
COARSE_POSE_TOLERANCE = [0.04, 0.04, 0.04, float("inf"), float("inf"), 0.05]
ULTRA_COARSE_POSE_TOLERANCE = [0.10, 0.10, 0.10, float("inf"), float("inf"), 0.18]

BINARY_P_POSE_TOLERANCE = [0.2, 0.2, 0.2, float("inf"), float("inf"), 0.10]

MAIN_LOOP_RATE = 60

# for deep end
#CENTER_BACK_POSE =  [-2.20, 0.15, 0.28, 0.0, 0, 0]

# for shallow end
CENTER_BACK_POSE =  [-2.55, 0.40, 0.05, 0.0, 0, 0]
CENTER_BACK_POSE_RIGHT =  [-2.55, -0.40, 0.05, 0.0, 0, 0]

SLOT_X_STRIDE = 0.083
SLOT_Z_STRIDE = 0.19

EXPERIMENT_MAX_DURATION_SECONDS = 14400.0

BLOCK_HELD_Z_I_GAIN = 0.15
BLOCK_HELD_X_I_GAIN = 0.10
BLOCK_HELD_Y_I_GAIN = 0.10

DEFAULT_X_I_GAIN = 0.10
DEFAULT_Y_I_GAIN = 0.10
DEFAULT_Z_I_GAIN = 0.10

MID_LOW_Z_OFFSET = 0.07
HIGH_Z_OFFSET = 0.25

SLOW_MOVE_HOLD_TIME = 6.0
RAPID_MOVE_HOLD_TIME = 3.0
GRIPPER_HOLD_TIME = 0.0

INTERMEDIATE_WAYPOINT_DISTANCE = 0.10

# BALLAST PARAMS
BALLAST_SCUBA_SERVO_INDEX = 1
BALLAST_TANK_OUTLET_SERVO_INDEX = 0
BALLAST_SCUBA_VALVE_FULL_OPEN_PWM = 1630 #1776
BALLAST_TANK_OUTLET_FULL_OPEN_PWM = 1750
BALLAST_TANK_OUTLET_CLOSED_PWM = 1540
BALLAST_SCUBA_VALVE_CLOSED_PWM = 1540
BALLAST_AIR_IN_PULSE_TIME = 0.75
BALLAST_AIR_OUT_PULSE_TIME = 2.0
BALLAST_AIR_OUT_PULSE_OFF_TIME = 3.0
BALLAST_AIR_IN_PULSE_OFF_TIME = 3.0

BALLAST_AIR_FILL_TIME_SECONDS = 1.5
BALLAST_AIR_EMPTY_TIME_SECONDS = 30.0

PRESSURE_TO_MH20 = 0.00010197

GRIPPER_OPEN_TIME = 12.0
GRIPPER_CLOSE_TIME = 14.5
GRIPPER_OPEN_PWM = 1000
GRIPPER_CLOSE_PWM = 1800
GRIPPER_STOP_PWM = 0
GRIPPER_SERVO_INDEX = 2

MAX_EFFORT_BUOYANCY_CHANGE = 0.90
